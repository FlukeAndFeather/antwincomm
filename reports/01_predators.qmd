---
title: "Predator summary"
format:
  html:
    code-fold: true
editor: visual
---

```{r}
#| label: setup
#| include: false

library(targets)
library(tidyverse)

tar_load(c("predators_agg", "sg_sf"), store = here::here("_targets"))
source(here::here("R", "sp.R"))
```

## South Georgia winter predators

### Counts

The six most abundant species.

```{r}

top_six <- predators_agg %>% 
  group_by(species) %>% 
  summarize(total_count = sum(count)) %>% 
  arrange(desc(total_count)) %>%
  slice(1:6)

top_six
```

```{r}

top_six_plot_data <- predators_agg %>% 
  semi_join(top_six, by = "species") %>% 
  group_by(year, species) %>% 
  summarize(total = sum(count), .groups = "drop") %>% 
  mutate(species = fct_reorder(species, total, .fun = sum),
         year = factor(year, levels = 2016:2012))
year_labels <- top_six_plot_data %>% 
  filter(species == "SNPT") %>% 
  arrange(desc(year)) %>%                   # Make the labels show up at
  mutate(total = cumsum(total) - total / 2) # correct y-axis position

ggplot(top_six_plot_data, aes(species, total, group = year)) +
  geom_col(color = "black", fill = "grey80") +
  geom_text(aes(label = year), year_labels) +
  labs(y = "Total species count") +
  theme_classic() +
  theme(axis.title.x = element_blank())
```

### Maps

```{r}
#| label: predator_map

predators_sf <- predators_agg %>% 
  semi_join(top_six, by = "species") %>% 
  filter(year == 2016) %>% 
  sf::st_as_sf(coords = c("lon_mean", "lat_mean"), 
               crs = sp::CRS("+proj=longlat +datum=WGS84"))

map_lim <- sf::st_bbox(predators_sf) %>% 
  sf::st_as_sfc(crs = "EPSG:4326") %>% 
  sf::st_transform(sg_proj()) %>% 
  sf::st_bbox()

ggplot() +
  geom_sf(data = sg_sf) +
  geom_sf(aes(color = count), data = predators_sf) +
  scale_color_gradient(low = "lightblue", high = "darkred",
                       limits = c(0, 1000)) +
  facet_wrap(~species) +
  coord_sf(xlim = map_lim[c("xmin", "xmax")] + c(-1e5, 1e5),
           ylim = map_lim[c("ymin", "ymax")] + c(-1e5, 1e5),
           expand = FALSE,
           crs = sg_proj()) +
  theme_minimal()

```
