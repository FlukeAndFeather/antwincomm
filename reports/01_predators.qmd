---
title: "Predator summary"
format:
  html:
    code-fold: true
editor: visual
output-dir: "docs"
---

```{r}
#| label: setup
#| include: false

library(sf)
library(targets)
library(tidyverse)

tar_load(c("predators_agg", "ant_sf", "effort_sf"), 
         store = here::here("_targets"))
source(here::here("R", "sp.R"))
```

## Counts

The five most abundant species (in ind nmi\^-1).

```{r}

top_five <- predators_agg %>% 
  group_by(species) %>% 
  summarize(total_count = sum(count_norm)) %>% 
  arrange(desc(total_count)) %>%
  slice(1:5)

top_five
```

```{r}

top_five_plot_data <- predators_agg %>% 
  semi_join(top_five, by = "species") %>% 
  group_by(year, species) %>% 
  summarize(total = sum(count_norm), .groups = "drop") %>% 
  mutate(species = fct_reorder(species, total, .fun = sum),
         year = factor(year, levels = 2016:2012))
year_labels <- top_five_plot_data %>% 
  filter(species == "SNPT") %>% 
  arrange(desc(year)) %>%                   # Make the labels show up at
  mutate(total = cumsum(total) - total / 2) # correct y-axis position

ggplot(top_five_plot_data, aes(species, total, group = year)) +
  geom_col(color = "black", fill = "grey80") +
  geom_text(aes(label = year), year_labels) +
  labs(y = "Total species count") +
  theme_classic() +
  theme(axis.title.x = element_blank())
```

## Maps

Survey effort. 21 out of the 19404 intervals were recorded as nmi \> 1000 (as opposed to \~1 nmi for the rest). Those intervals excluded from the survey effort.

### Climatologies

```{r}
#| label: species_climatologies

library(terra)
# Mkae "top five" predator sightings spatially aware
topfive_sf <- predators_agg %>% 
  semi_join(top_five, by = "species") %>% 
  latlon_to_sf(coords = c("lon_mean", "lat_mean"))
# Create a template raster of the study area
effort_ext <- effort_sf %>% 
  st_transform(ant_proj()) %>% 
  ext()
rast_template <- rast(crs = as.character(ant_proj())[[1]],
                      extent = effort_ext,
                      resolution = 30e3)
# Rasterize effort by year
effort_rast <- effort_sf %>% 
  st_transform(ant_proj()) %>% 
  rasterize(rast_template,
            field = "nmi",
            by = "year",
            fun = sum)
# Rasterize the predator sightings by year and species
topfive_rast <- topfive_sf %>% 
  st_transform(ant_proj()) %>% 
  mutate(year_species = interaction(year, species)) %>% 
  rasterize(rast_template, 
            field = "count",
            by = "year_species",
            fun = sum)
# Normalize counts by effort
topfive_norm <- topfive_rast
for (i in seq(nlyr(topfive_rast))) {
  lyr_name <- names(topfive_rast)[i]
  lyr_year <- substr(lyr_name, 1, 4)
  effort_year <- effort_rast[lyr_year] %>% 
    subst(0, NA)
  topfive_norm[[i]] <- topfive_norm[[i]] / effort_year
}
# Average across years
topfive_climatology <- unique(top_five$species) %>% 
  map(function(sp) {
    sp_rast <- subset(topfive_norm, 
                      which(str_detect(names(topfive_norm), sp)))
    mean(sp_rast, na.rm = TRUE)
  }) %>% 
  set_names(unique(top_five$species)) %>% 
  rast()
# Classify raster (otherwise CRSE throw it all off)
topfive_clim_class <- topfive_climatology %>% 
  classify(rcl = c(0, 1, 5, 10, 50))

# Project bounding box
map_bbox <- ext(-63, -54, -64, -59) %>% 
  project(from = "+proj=longlat +datum=WGS84",
          to = as.character(ant_proj())[[1]])
 
# Make the map! 
ant_basemap() +
  tidyterra::geom_spatraster(data = topfive_clim_class) +
  geom_sf(data = tar_read("ant_sf", store = here::here("_targets"))) +
  scale_fill_brewer(palette = "RdPu", 
                    na.value = NA, 
                    direction = 1,
                    na.translate = FALSE) +
  scale_x_continuous(breaks = seq(-64, -54, by = 4)) +
  scale_y_continuous(breaks = seq(-64, -59, by = 2)) +
  labs(fill = "Ind nmi^-1") +
  facet_wrap(~lyr) +
  coord_sf(xlim = map_bbox[1:2],
           ylim = map_bbox[3:4],
           crs = ant_proj()) +
  theme(legend.position = "top")

```

### Survey effort

```{r}
#| label: survey_effort
#| warning: false

map_bbox <- ext(effort_rast)

ant_basemap(map_bbox) +
  tidyterra::geom_spatraster(data = effort_rast) +
  scale_fill_distiller(palette = "PuRd", 
                       direction = 1, 
                       na.value = NA) +
  scale_x_continuous(breaks = seq(-64, -54, by = 4)) +
  scale_y_continuous(breaks = seq(-64, -57, by = 2)) +
  coord_sf(xlim = map_bbox[1:2],
           ylim = map_bbox[3:4],
           crs = ant_proj()) +
  labs(fill = "nmi") +
  facet_wrap(~lyr) +
  expand_limits(fill = 0)

```

### Yearly distributions

Distribution maps of the five most abundant species in each survey year, aggregated to 30km bins.

```{r}
#| label: topfive_map
#| warning: false
#| column: screen
#| out-width: 100%
#| fig-width: 6
#| fig-dpi: 600

map_bbox <- ext(-63, -54, -64, -59) %>% 
  project(from = "+proj=longlat +datum=WGS84",
          to = as.character(ant_proj())[[1]])

topfive_class <- topfive_rast %>% 
  classify(rcl = c(0, 1, 5, 10, 50, 100, 1000, Inf))

topfive_class_df <- as.data.frame(topfive_class, xy = TRUE) %>% 
  pivot_longer(-c("x", "y"), 
               names_to = "name", 
               values_to = "count") %>% 
  separate_wider_delim(name, 
                       delim = ".", 
                       names = c("year", "species")) %>% 
  drop_na(count)

ant_basemap() +
  geom_raster(aes(x, y, fill = count), topfive_class_df) +
  geom_sf(data = tar_read("ant_sf", store = here::here("_targets"))) +
  scale_fill_brewer(palette = "RdPu", 
                    na.value = NA, 
                    direction = 1,
                    na.translate = FALSE) +
  scale_x_continuous(breaks = seq(-64, -54, by = 4)) +
  scale_y_continuous(breaks = seq(-64, -59, by = 2)) +
  labs(fill = "Ind nmi^-1") +
  facet_grid(species ~ year) +
  coord_sf(xlim = map_bbox[1:2],
           ylim = map_bbox[3:4],
           crs = ant_proj()) +
  theme(legend.position = "right",
        text = element_text(size = 8))
```

Distribution maps of five species of interest in each survey year, also aggregated to 25km bins.

```{r}
#| label: soi_map
#| warning: false
#| column: screen
#| out-width: 100%
#| fig-width: 6
#| fig-dpi: 600

soi <- c("GEPN", "BLPT", "ANTE", "LESE", "KIWH")

soi_sf <- predators_agg %>% 
  filter(species %in% soi) %>% 
  latlon_to_sf(coords = c("lon_mean", "lat_mean"))

soi_rast <- soi_sf %>% 
  st_transform(ant_proj()) %>% 
  mutate(year_species = interaction(year, species)) %>% 
  rasterize(rast_template, 
            field = "count",
            by = "year_species",
            fun = sum)

map_bbox <- ext(-63, -54, -64, -59) %>% 
  project(from = "+proj=longlat +datum=WGS84",
          to = as.character(ant_proj())[[1]])

soi_class <- soi_rast %>% 
  classify(rcl = c(0, 1, 5, 10, 50, 100, 1000))

soi_class_df <- as.data.frame(soi_class, xy = TRUE) %>% 
  pivot_longer(-c("x", "y"), 
               names_to = "name", 
               values_to = "count") %>% 
  separate_wider_delim(name, 
                       delim = ".", 
                       names = c("year", "species")) %>% 
  drop_na(count)

ant_basemap() +
  geom_raster(aes(x, y, fill = count), soi_class_df) +
  geom_sf(data = tar_read("ant_sf", store = here::here("_targets"))) +
  scale_fill_brewer(palette = "RdPu", 
                    na.value = NA, 
                    direction = 1,
                    na.translate = FALSE) +
  scale_x_continuous(breaks = seq(-64, -54, by = 4)) +
  scale_y_continuous(breaks = seq(-64, -59, by = 2)) +
  labs(fill = "Ind nmi^-1") +
  facet_grid(species ~ year) +
  coord_sf(xlim = map_bbox[1:2],
           ylim = map_bbox[3:4],
           crs = ant_proj()) +
  theme(legend.position = "right",
        text = element_text(size = 8))
```
