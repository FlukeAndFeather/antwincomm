---
title: "Predator clusters"
format:
  html:
    code-fold: true
    toc: true
editor: visual
output-dir: "docs"
bibliography: references.bib
---

```{r}
#| label: setup
#| include: false

library(cluster)
library(ggmosaic)
library(ggtree)
library(patchwork)
library(sf)
library(targets)
library(tidyterra)
library(tidyverse)
library(vegan)

tar_load(
  c("predators_clust", "stations_clust", "sightings_cut",
    "seaice_conc_df", "seaice_contours", "stations_ice",
    starts_with("sightings"),
    starts_with("nmds"),
    "zoop_sf", "ant_sf"), 
  store = here::here("_targets")
)
source(here::here("R", "sp.R"))
source(here::here("R", "zoop.R"))
seaice_contours <- terra::unwrap(seaice_contours)
```

## Predator clusters

Dietrich et al. (2021) restricted cluster analysis to taxa observed at 5% or more of stations, which was necessary to avoid giving rare species too much leverage. Predators are far less diverse, so this analysis retains all species except uncertain IDs (e.g. UNSE = unknown seal). `r n_distinct(predators_clust$species)` species included in analysis.

```{r}
#| label: abundant_predators

total_stations <- n_distinct(zoop_sf$amlr.station)
pred_frac <- predators_clust %>%
  as_tibble() %>% 
  group_by(amlr.station, species) %>% 
  summarize(count_station = sum(count),
            .groups = "drop") %>% 
  group_by(species) %>%
  summarize(total_count = sum(count_station),
            stations_present = n(),
            station_frac = stations_present / total_stations) %>%
  arrange(desc(station_frac))
  
frac_fn <- scales::label_percent(accuracy = 0.1)
pred_frac %>% 
  set_names(c("Species", "Ind", "Stations", "Fraction")) %>% 
  mutate(Fraction = frac_fn(Fraction)) %>% 
  knitr::kable(align = "lrr") %>% 
  kableExtra::kable_styling("striped",
                            full_width = FALSE)

```

## Optimal number of clusters

We use the gap statistic [@tibshirani2001] to choose the optimal number of clusters ($k$). The gap statistic ($f$) is a goodness of clustering measure. The authors recommended choosing $k$ at the shoulder of the $f \sim k$ curve. Heuristically, the shoulder is the smallest $k$ such that $f(k) \geq f(k+1) - s(k+1)$ where $s$ is the standard error of $f$. According to this rule, the predators are best described by one cluster. However, there's a clear jump from $k=2$ to $k=3$ (red), followed by a leveling off. Therefore, based on our prior knowledge of three predator guilds (pagophilic, open water, and marginal ice), we'll present the results for $k=3$ here.

```{r}
#| label: optimal-clusters

ktibs <- with(sightings_gap, k[is_optimum])
tibs_thr <- with(sightings_gap, gap[ktibs + 1] - SE.sim[ktibs + 1])
ggplot(sightings_gap, aes(x = k, y = gap)) +
  geom_line() +
  geom_pointrange(aes(ymin = gap - SE.sim, ymax = gap + SE.sim,
                      color = is_optimum)) +
  geom_pointrange(aes(ymin = gap - SE.sim, ymax = gap + SE.sim),
                  filter(sightings_gap, k == 3),
                  color = "red") +
  geom_segment(x = ktibs, xend = ktibs + 1, 
               y = tibs_thr, yend = tibs_thr,
               color = "blue",
               linetype = "dashed") +
  scale_color_manual(values = c(`TRUE` = "blue",
                                `FALSE` = "black")) +
  theme_classic() +
  theme(legend.position = "none")
```

Hierarchical clustering of stations by predator community. Note: `r nrow(zoop_sf)` stations were included in the zooplankton clustering, but only `r length(sightings_clust$labels)` stations were used for predator clustering.

```{r}
#| label: predator_dendro

g <- split(names(sightings_cut), sightings_cut)
p <- ggtree(sightings_clust, hang = -1)
pred_clust_mrca <- sapply(g, function(n) MRCA(p, n))

p %>% 
  groupClade(pred_clust_mrca, group_name = "Predator cluster") + 
  aes(color = `Predator cluster`) +
  layout_dendrogram() +
  theme_dendrogram()
```

## Indicator species

Which species best represent each cluster? Using Dufrene-Legendre indicator species analysis. Apply indicator value cutoff at 25%.

```{r}
#| label: indicator_species

indval_mtx <- sightings_indval$indval
indval_fmt <- apply(indval_mtx, 2, function(x) {
  ord <- order(x, decreasing = TRUE)
  result <- ifelse(x >= 0.25, 
         str_glue("{rownames(indval_mtx)} ({round(x * 100)}%)"),
         NA) %>% 
    `[`(ord) %>% 
    na.omit() %>% 
    paste(collapse = "<br>")
  ifelse(result == "", "None", result)
})
as_tibble(t(indval_fmt)) %>% 
  knitr::kable(format = "html", escape = FALSE) %>% 
  kableExtra::kable_styling()

```

### Cluster interpretation

-   Cluster 1 = open water
-   Cluster 2 = marginal ice zone
-   Cluster 3 = pagophilic

Indicator value $d_{ic}$ of species $i$ in cluster $c$ is the product of relative fidelity, $f_{ic}$, and relative abundance, $a_{ic}$. See documentation of `labdsv::indval()`.

Relative fidelity $f_{ic}$ of species $i$ in cluster $c$ is:

$$
f_{ic} = \frac{\sum_{j \in c}p_{ij}}{n_c}
$$

Relative abundance $a_{ic}$ is:

$$
a_{ic}=\frac{\sum_{j \in c}x_{ij}/n_c}{\sum_{k=1}^K (\sum_{j \in k}x_{ij}/n_k)}
$$

A high indicator value, e.g., $d_{ic}\approx1$, means species $i$ is present in nearly all sites in cluster $c$ and nearly absent from sites not in $c$. The greatest $d_{ic}$ observed here was Adèlie penguins in cluster 3 at 0.74. ADPN were observed in 45 of the 60 cluster 3 sites, for $f_{ic}=0.75$. The average abundance of ADPN in cluster 1 was 4.04 ind nm\^-1, compared to 0.113 and 0.166 in clusters 2 and 3, respectively. Yields $a_{ic}=0.935$.

Note that differences in indicator values between species reflect *relative* changes in frequency/abundance. For example, in cluster 3 (pagophilic predators), Antarctic fur seals were found at more stations ($f_{ic}=0.783$) and in higher abundances (mean 2.22 ind nm\^-1) than crabeater seals ($f_{ic}=0.650$, mean 1.73 ind nm\^-1), yet they have the same indicator value $d_{ic}=0.63$. That's because Antarctic fur seals were still somewhat abundant in another cluster whereas crabeater seals were concentrated in cluster 3. Specifically, mean Antarctic fur seal abundance was 0.441 ind nm\^-1 in cluster 2 (marginal ice zone), 19.9% of their cluster 1 abundance. Crabeater seals dropped from 1.73 ind nm\^-1 to 0.133 ind nm\^-1, or 7.7% of cluster 1 abundance.

Comparing the highest indicator values between clusters, the pagophilic community has the most distinct collection of predators, followed by the marginal ice zone and open water communities. Three species had $d_{ic} \gt 0.6$ in the pagophilic cluster: Adèlie penguins, Antarctic fur seals, and crabeater seals. All three of these species were both more prevalent and more abundant in the pagophilic cluster than either of the other two. In contrast, the open water community had no species with $d_{ic} \gt 0.35$. The three most prevalent species in the open water cluster were snow petrels, Antarctic petrels, and southern giant petrels, all of which were more abundant in the marginal ice zone cluster. Meaning, the pagophilic community was distinct because of specific species (Adèlie penguins, Antarctic fur seals, and crabeater seals), while the open water community was characterized by more variable species compositions. The marginal ice zone community fell in between. Its highest indicator value species (snow petrel, Antarctic petrel, and southern giant petrel) were widespread across communities, so their relative abundances in the marginal ice zone cluster were lower ($a_{ic} \in [0.400 - 0.652]$) than the three highest indicator value species were in the pagophilic cluster ($a_{ic} \in [0.810 - 0.971]$).

```{r}
#| label: indval_interpret

# Adelie penguin x cluster 3 worked example
adpn <- filter(predators_clust, species == "ADPN")

pic_adpn <- sum(adpn$pred_clust == "Pagophilic")
nc3 <- sum(sightings_cut == 3)
fic_adpn <- pic_adpn / nc3

abu_adpn <- adpn %>% 
  group_by(pred_clust) %>% 
  summarize(abu = sum(count_nmi) / n())
aic_adpn <- abu_adpn$abu[3] / sum(abu_adpn$abu)

# ANFU x cluster 1
anfu <- filter(predators_clust, species == "ANFU")

pic_anfu <- sum(anfu$pred_clust == "Open")
nc1 <- sum(sightings_cut == 1)
fic_anfu <- pic_anfu / nc1

abu_anfu <- anfu %>% 
  group_by(pred_clust) %>% 
  summarize(abu = sum(log(count_nmi + 1)) / n())
aic_anfu <- abu_anfu$abu[1] / sum(abu_anfu$abu)

```

## Cluster distribution

How frequent are the different clusters? The marginal ice zone predator community was observed most often, followed by the open water then the pagophilic communities. The pagophilic community was observed most frequently in 2016. Sea ice extent was less in 2016 than 2013 and 2015, so the relative frequency of the pagophilic community in 2016 is initially surprising. However, it may be explained by the greater sea ice in 2013 and 2015 limiting survey access to the Bransfield Strait.

```{r}
#| label: cluster_freq

stations_clust %>% 
  mutate(Year = factor(Year)) %>% 
  crosstable::crosstable("Year", by = "pred_clust", total = "col") %>% 
  crosstable::as_flextable()

```

What geospatial patterns do we see in the predator communities? The pagophilic predator community (purple) was largely found within the Bransfield Strait. The marginal ice zone community was mostly distributed around the South Shetland Islands, however in the years 2013 and 2015 (when sea ice extent was greatest) this community was more frequent further offshore. The open water community was found furthest off shore (north in 2012 and 2014, west in 2016), with the exception of 2015 when it moved south to the entrance of the Bransfield Strait, even moving within the Strait. Is this the result of polynyas? Blue line indicates 65% ice concentration contour during the month of August in each year. Notice the limited coverage of the Bransfield Strait in 2012 and 2013, and the absence of eastern stations in 2016.

```{r}
#| label: cluster_maps

map_lim <- st_bbox(stations_clust) %>% 
  project_bbox() %>% 
  expand_bbox(factor = 1.2)

icy_open <- filter(stations_clust,
                   pred_clust == "Open",
                   ice_coverage >= 7.5)

ant_basemap(map_lim) +
  geom_sf(aes(color = pred_clust), 
          stations_clust, 
          size = 2, 
          shape = 15) +
  # geom_sf(data = filter(stations_clust, 
  #                       amlr.station %in% c("AMLR2015_W1111",
  #                                           "AMLR2015_W1113")),
  #         color = "yellow") +
  geom_sf(data = seaice_contours, color = "skyblue") +
  facet_wrap(~ Year) +
  scale_x_continuous(breaks = c(-60, -55)) +
  scale_y_continuous(breaks = c(-63, -62, -61, -60)) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_gradient(lim = c(0, 1), na.value = "transparent") +
  coord_ant(map_lim) +
  theme(legend.position = "bottom")
```

## NMDS

How many NMDS axes should we use? Scree plot

```{r}
#| label: nmds-scree

ggplot(nmds_stress, aes(k, stress)) +
  geom_line() +
  geom_point() +
  geom_hline(yintercept = c(0.2, 0.1, 0.05), linetype = "dotted") +
  scale_x_continuous(breaks = nmds_stress$k) +
  expand_limits(y = 0) +
  theme_classic()

```

3 axes for NMDS looks acceptable. How does ordination distance compare to dissimilarity (Shepard diagram)?

```{r}
#| label: nmds-shepard

nmds_spear <- cor(nmds_shepard$diss,
                  nmds_shepard$dist,
                  method = "spearman")
nmds_label <- str_glue(
  "Non-metric fit, R^2 = {round(1 - nmds_sightings$stress^2, 3)}\n",
  "Linear fit, R^2 = {round(nmds_spear^2, 3)}\n",
  "k = {nmds_sightings$ndim}\n",
  "Stress = {round(nmds_sightings$stress, 3)}"
)

ggplot(nmds_shepard, aes(diss, dist)) +
  geom_point(size = 0.75, alpha = 0.1) +
  geom_line(aes(y = mono), color = "red") +
  annotate("text", x = 0.05, y = 2.9, label = nmds_label,
           hjust = 0, vjust = 1) +
  expand_limits(x = 0, y = 0) +
  labs(x = "Observed dissimilarity",
       y = "Ordination distance") +
  theme_classic()

```

NMDS plots, color-coded by predator cluster.

```{r}
#| label: loading

ggplot(nmds_df, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = pred_clust)) +
  scale_color_brewer(palette = "Dark2") +
  theme_classic()

ggplot(nmds_df, aes(NMDS1, NMDS3)) +
  geom_point(aes(color = pred_clust)) +
  scale_color_brewer(palette = "Dark2") +
  theme_classic()

ggplot(nmds_df, aes(NMDS2, NMDS3)) +
  geom_point(aes(color = pred_clust)) +
  scale_color_brewer(palette = "Dark2") +
  theme_classic()
```

## Environmental loadings

I compared the drivers of community structure two ways: physics (hydrology and ice coverage) and zooplankton (community assignments). Here's what makes jumps out at me:

-   Predator cluster associations with ice kind of track with what we expected. The pagophilic predator cluster correlates with first-year ice, open ocean predators with open ice, marginal ice predators with thin ice. Weirdly, multi-year ice falls among the open ocean predators, but only two stations were classified as multi-year ice so it's probably a small sample size thing.
-   Predator cluster 1 (open water) and 2 (marginal ice zone) are associated with higher temperatures and zooplankton cluster 2 (small euphausiids, amphipods, etc). They differ in the open water predator cluster was found in areas with greater phaeopigment and the marginal ice cluster in areas with greater chlorophyll-a.
-   Predator cluster 3 (pagophilic) is associated with higher salinity, deeper mixed layer, and macrozooplankton cluster 3 (big euphausiids, Metridia, etc)
-   Macrozooplankton cluster 1 (salps etc) evenly distributed across predator clusters

```{r}
#| label: env-loadings



```

```{r}
#| label: env-loadings-old
#| eval: false

station_ice <- predators_stations %>% 
  distinct(amlr.station, ice_type, ice_coverage) %>% 
  as_tibble()

# Evironmental variables
station_env <- zoop_sf %>% 
  select(amlr.station, zuml_m, avg.temp, avg.salinity, Integ.chla.100m, 
         Integ.phae.100m, TOD_2levels_civil, Year, 
         zoop = `Winter Cluster factor`) %>% 
  as_tibble() %>% 
  left_join(stations_ice, by = "amlr.station") %>% 
  mutate(Year = factor(Year)) %>% 
  slice(map_int(rownames(sightings_mtx),
                ~ which(.x == amlr.station))) %>% 
  select(-amlr.station, -geometry)

# Fit multiple regression model
pred_envfit <- envfit(nmds_sightings, 
                      station_env, 
                      permutations = 999, 
                      choices = 1:3,
                      na.rm = TRUE)

# Extract envfit vectors and factors
envfit_vecs <- scores(pred_envfit, 
                      display = "vectors",
                      choices = 1:3) %>% 
  as_tibble(rownames = "envvar") %>% 
  mutate(across(starts_with("NMDS"),
                ~ .x * ordiArrowMul(pred_envfit)))
envfit_facs <- scores(pred_envfit, 
                      display = "factors",
                      choices = 1:3) %>% 
  as_tibble(rownames = "envvar") %>% 
  mutate(across(starts_with("NMDS"),
                ~ .x * ordiArrowMul(pred_envfit)))

# Hydrology plot
hydro_plot <- ggplot(nmds_df, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = pred_clust)) +
  geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               data = envfit_vecs,
               linewidth = 1,
               color = "grey50",
               alpha = 0.6) +
  ggrepel::geom_text_repel(aes(x = NMDS1, y = NMDS2, label = envvar),
                           data = envfit_vecs) +
  scale_color_brewer(palette = "Dark2") +
  theme_classic()

# Ice plot
ice_facs <- filter(envfit_facs, str_detect(envvar, "ice_type"))
ice_plot <- ggplot(nmds_df, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = pred_clust)) +
  geom_point(aes(x = NMDS1, y = NMDS2),
             data = ice_facs,
             size = 2) +
  ggrepel::geom_text_repel(aes(x = NMDS1, y = NMDS2, label = envvar),
                           data = ice_facs) +
  scale_color_brewer(palette = "Dark2") +
  theme_classic()

# Macrozooplankton plot
zoop_facs <- filter(envfit_facs, str_detect(envvar, "zoop"))
zoop_plot <- ggplot(nmds_df, aes(NMDS1, NMDS2)) +
  geom_point(aes(color = pred_clust)) +
  geom_point(aes(x = NMDS1, y = NMDS2),
             data = zoop_facs,
             size = 2) +
  ggrepel::geom_text_repel(aes(x = NMDS1, y = NMDS2, label = envvar),
                           data = zoop_facs) +
  scale_color_brewer(palette = "Dark2") +
  theme_classic()

layout <- "
AAAA
AAAA
BBCC
"
hydro_plot + ice_plot + zoop_plot + 
  plot_layout(design = layout, guides = "collect")
```

Summaries of environmental conditions by cluster.

```{r}
#| label: env_summ
#| eval: false

env <- tibble(
  amlr.station = names(clust),
  pred_clust = factor(clust,
                      labels = c("Open", "Marginal", "Pagophilic"))
) %>% 
  left_join(
    select(as_tibble(zoop_sf),
           amlr.station, avg.salinity, Integ.chla.100m),
    by = "amlr.station") %>% 
  left_join(select(stations_ice, amlr.station, ice_coverage),
            by = "amlr.station") %>% 
  pivot_longer(avg.salinity:ice_coverage, 
               names_to = "envvar",
               values_to = "envval")
env %>% 
  group_by(envvar) %>% 
  summarize(envaov = list(aov(envval ~ pred_clust))) %>% 
  mutate(Fval = map_dbl(envaov, \(aov) summary(aov)[[1]]$`F value`[1]),
         pval = map_dbl(envaov, \(aov) summary(aov)[[1]]$`Pr(>F)`[1]))
env %>% 
  group_by(pred_clust, envvar) %>% 
  summarize(across(envval, list(mean = partial(mean, na.rm = TRUE),
                                sd = partial(sd, na.rm = TRUE))),
            .groups = "drop")
```

## Clusters by ice coverage

I asserted the clusters corresponded to open water, marginal ice, and pack ice communities. Let's verify that.

```{r}
#| eval: false
pred_clust_ice <- tibble(
  amlr.station = names(clust),
  pred_clust = factor(clust,
                      labels = c("Open", "Marginal", "Pagophilic"))
) %>% 
  left_join(stations_ice,
            by = "amlr.station") %>% 
  drop_na(ice_coverage)

ggplot(pred_clust_ice, aes(x = ice_coverage / 10, fill = after_stat(x))) + 
  geom_histogram(bins = 20, color = "grey30") +
  scale_x_continuous(labels = scales::percent) +
  scale_fill_distiller(palette = "Blues", guide = NULL) +
  facet_grid(rows = vars(pred_clust)) +
  labs(x = "Ice coverage",
       y = "Station count") +
  theme_minimal()

```

## Predator *x* prey clusters

Predator/prey cluster associations were statistically significant. The most positive residuals were between pagophilic predators x zooplankton 3b (4.07), pagophilic predators x zooplankton 3a (2.68), marginal ice zone predators x zooplankton 2a (2.33), and open water predators x zooplankton 2b (1.82). Zooplankton 1 was not

```{r}
#| eval: false
pred_prey <- as_tibble(pred_clust) %>% 
  select(amlr.station, pred_clust) %>% 
  left_join(select(as_tibble(zoop_sf), 
                   amlr.station, 
                   prey_clust = `Winter Cluster factor`),
            by = "amlr.station")
pred_prey_chisq <- with(pred_prey, chisq.test(pred_clust, prey_clust))
pred_prey_chisq
pred_prey_chisq$residuals

```

## 
